# 故障排除指南

## 常见错误及解决方案

### 1. "处理响应消息时出错: 'payload'" 错误

**错误描述：**
```
处理响应消息时出错: 'payload'
WebSocket连接已关闭. 状态码: None, 消息: None
调用星火大模型失败: 处理响应消息时出错: 'payload'
```

**可能原因：**
1. API凭证配置错误
2. 网络连接问题
3. API服务响应格式异常
4. 请求参数不正确

**解决步骤：**

#### 步骤1：检查API凭证配置
```bash
# 运行测试脚本检查配置
python test_api.py
```

确保以下环境变量已正确设置：
- `SPARK_APPID`: 应用ID
- `SPARK_APIKEY`: API密钥
- `SPARK_APISECRET`: API密钥

#### 步骤2：验证.env文件
检查项目根目录的`.env`文件：
```
SPARK_APPID="你的应用ID"
SPARK_APIKEY="你的API密钥"
SPARK_APISECRET="你的API密钥"
```

#### 步骤3：检查网络连接
确保能够访问科大讯飞API服务器：
```bash
ping spark-api.xf-yun.com
```

#### 步骤4：查看详细日志
启动应用时会显示详细的调试信息，注意查看：
- WebSocket连接状态
- 发送的请求消息
- 收到的响应消息

### 2. "API凭证未配置" 错误

**错误描述：**
```
API凭证未配置，请检查环境变量 SPARK_APPID, SPARK_APIKEY, SPARK_APISECRET
```

**解决方案：**
1. 复制`.env.example`为`.env`
2. 在讯飞开放平台获取API凭证
3. 填入`.env`文件中

### 3. "未收到AI模型的有效响应内容" 错误

**可能原因：**
1. 网络超时
2. API服务异常
3. 请求内容过长或格式不当

**解决方案：**
1. 检查网络连接
2. 减少输入内容长度
3. 稍后重试

### 4. "JSON解析错误" 错误

**错误描述：**
```
JSON解析错误: Expecting value: line 1 column 1 (char 0)
```

**可能原因：**
1. AI返回的内容不是有效的JSON格式
2. 响应内容被截断
3. 网络传输错误

**解决方案：**
1. 查看控制台输出的原始响应内容
2. 检查网络连接稳定性
3. 尝试重新发送请求

### 5. 文件上传相关错误

**错误描述：**
```
读取Word文件失败: [Errno 2] No such file or directory
```

**解决方案：**
1. 确保上传的是有效的.docx或.txt文件
2. 检查文件是否损坏
3. 尝试重新上传

## 调试技巧

### 1. 启用详细日志
修改后的代码已经包含详细的调试信息，启动应用时会显示：
- API配置状态
- WebSocket连接过程
- 请求和响应内容
- 错误详细信息

### 2. 使用测试脚本
运行测试脚本验证配置：
```bash
python test_api.py
```

### 3. 检查控制台输出
注意查看以下信息：
- `✅ API凭证配置检查通过`
- `🔗 认证URL生成成功`
- `🚀 开始WebSocket连接...`
- `收到WebSocket消息: ...`

### 4. 分步测试
1. 先测试简单的文本输入
2. 再测试文件上传
3. 逐步增加内容复杂度

## 联系支持

如果问题仍然存在，请：

1. **收集错误信息：**
   - 完整的错误消息
   - 控制台输出日志
   - 使用的输入内容类型和大小

2. **检查环境：**
   - Python版本
   - 依赖包版本
   - 操作系统信息

3. **验证配置：**
   - API凭证是否有效
   - 网络连接是否正常
   - 模板文件是否存在

## 预防措施

1. **定期检查API凭证有效性**
2. **保持网络连接稳定**
3. **控制输入内容大小（建议不超过5000字符）**
4. **定期更新依赖包**
5. **备份重要的配置文件**
